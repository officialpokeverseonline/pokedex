<!-- ======================= pokemon.html (VERS√ÉO √Ä PROVA DE BUG) ======================= -->
<!DOCTYPE html>
<html lang="pt">
<head>
<meta charset="UTF-8">
<title>Pokemon Viewer</title>

<style>
body{
  background:#111;
  color:#eee;
  font-family:Consolas, monospace;
  padding:20px;
}

pre{
  background:#000;
  padding:20px;
  border-radius:8px;
  max-height:55vh;
  overflow:auto;
}

.nav, .evolutions, .forms{
  display:flex;
  justify-content:center;
  gap:20px;
  margin:15px 0;
  text-align:center;
}

.item{
  display:flex;
  flex-direction:column;
  align-items:center;
  font-size:12px;
}

img{
  width:80px;
  height:80px;
  object-fit:contain;
  background:#222;
  border-radius:10px;
  padding:6px;
  cursor:pointer;
}

.section-title{
  text-align:center;
  font-weight:bold;
  margin:16px 0 6px;
}

.actions{
  text-align:center;
}

.error{
  color:#ff6666;
  white-space:pre-wrap;
}
</style>
</head>

<body>

<div class="nav" id="nav"></div>

<div class="section-title">EVOLUTIONS</div>
<div class="evolutions" id="evolutions"></div>

<div class="section-title">FORMS</div>
<div class="forms" id="forms"></div>

<div class="actions">
  <button onclick="location.href='index.html'">‚¨Ö Voltar</button><br>
  <button onclick="copyCode()">üìã Copiar c√≥digo</button>
</div>

<pre id="code">Carregando‚Ä¶</pre>

<script type="module">
import { assemblePokemon } from "/core/assembler.js"

const params = new URLSearchParams(location.search)
const id = Number(params.get("id") || 1)

const artwork = i =>
`https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${i}.png`

const cap = s => s.charAt(0).toUpperCase()+s.slice(1)

window.copyCode = ()=>{
  navigator.clipboard.writeText(document.getElementById("code").innerText)
}

window.go = i => location.href = `pokemon.html?id=${i}`

async function safeFetch(url){
  const r = await fetch(url)
  if(!r.ok) throw new Error(`Erro ao carregar ${url}`)
  return r.json()
}

async function load(){
  try{
    const p = await safeFetch(`https://pokeapi.co/api/v2/pokemon/${id}`)
    const s = await safeFetch(p.species.url)

    /* ===== C√ìDIGO LUA ===== */
    const lua = await assemblePokemon(id)
    document.getElementById("code").innerText = lua

    /* ===== NAV ===== */
    const nav = document.getElementById("nav")
    nav.innerHTML = ""

    if(id > 1){
      const prev = await safeFetch(`https://pokeapi.co/api/v2/pokemon/${id-1}`)
      nav.innerHTML += `
        <div class="item" onclick="go(${id-1})">
          <div>Previous</div>
          <img src="${artwork(id-1)}">
          <div>${cap(prev.name)}</div>
        </div>`
    }

    nav.innerHTML += `
      <div class="item">
        <img src="${artwork(id)}">
        <div>${cap(p.name)}</div>
      </div>`

    const next = await safeFetch(`https://pokeapi.co/api/v2/pokemon/${id+1}`)
    nav.innerHTML += `
      <div class="item" onclick="go(${id+1})">
        <div>Next</div>
        <img src="${artwork(id+1)}">
        <div>${cap(next.name)}</div>
      </div>`

    /* ===== EVOLUTIONS ===== */
    const evoDiv = document.getElementById("evolutions")
    evoDiv.innerHTML = ""

    const evoChain = await safeFetch(s.evolution_chain.url)

    async function walk(node){
      const sp = await safeFetch(`https://pokeapi.co/api/v2/pokemon/${node.species.name}`)
      evoDiv.innerHTML += `
        <div class="item" onclick="go(${sp.id})">
          <img src="${artwork(sp.id)}">
          <div>${cap(node.species.name)}</div>
        </div>`
      for(const e of node.evolves_to) await walk(e)
    }
    await walk(evoChain.chain)

    /* ===== FORMS ===== */
    const formsDiv = document.getElementById("forms")
    formsDiv.innerHTML = ""

    for(const v of s.varieties){
      if(v.is_default) continue
      const fp = await safeFetch(v.pokemon.url)
      formsDiv.innerHTML += `
        <div class="item" onclick="go(${fp.id})">
          <img src="${artwork(fp.id)}">
          <div>${cap(v.pokemon.name.replace(/-/g," "))}</div>
        </div>`
    }

  }catch(err){
    document.getElementById("code").innerHTML =
      `<div class="error">ERRO CR√çTICO:\n${err.message}\n\nVerifique:\n1) se est√° usando Live Server / Codespace\n2) se /data/items.xml existe\n3) Console (F12)</div>`
    console.error(err)
  }
}

load()
</script>

</body>
</html>
